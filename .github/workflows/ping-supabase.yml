name: Ping Supabase keep-alive

on:
  schedule:
    # Runs daily at 00:00 UTC. Supabase pauses after 7 days of inactivity; daily is safe.
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (to keep logs clear)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Supabase keep-alive ping
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          # If the script exists in repo (scripts/ping-supabase.sh), execute it.
          if [[ -f "./scripts/ping-supabase.sh" ]]; then
            # Use bash to run it even if it lacks the executable bit
            bash ./scripts/ping-supabase.sh
          else
            # Fallback minimal curl ping if script is missing
            PING_URL="${SUPABASE_URL%/}/rest/v1/?select="
            HTTP_CODE=$(curl -sS -o /dev/null -w '%{http_code}' \
              -H "apikey: ${SUPABASE_ANON_KEY}" \
              # -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
              --connect-timeout 10 \
              --max-time 20 \
              "${PING_URL}" || echo "000")
            TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            echo "${TS} - Pinged ${PING_URL} - HTTP ${HTTP_CODE}"
          fi
