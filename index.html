<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Check Service Boundary</title>
    <!-- Use the standard CDN link for supabase-js -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <style>
      /* Standardise the page font and base text settings */
      body {
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 16px;
        line-height: 1.4;
        color: #111;
        margin: 1rem;
      }

      /* spacing between the search controls and the output */
      #controls {
        margin-bottom: 1.25rem;
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      #result {
        margin-top: 0.5rem;
      }

      /* make "Out of boundary" appear in red */
      .out {
        color: red;
      }

      /* make the service boundary result large, bold, and spaced */
      .boundary {
        display: block;
        margin-top: 1rem;    /* line spacing above the boundary result */
        margin-bottom: 0.75rem;
        font-size: 1.5rem;   /* large font */
        font-weight: 700;    /* bold */
        line-height: 1.2;
      }

      .status {
        margin: 0.25rem 0;
      }

      /* small polish for inputs and button to match font */
      input[type="text"], button {
        font: inherit;
      }
    </style>
  </head>
  <body>
    <h1>Check Service Boundary</h1>

    <div id="controls">
      <label for="postalInput">Enter postal code:</label>
      <input type="text" id="postalInput" placeholder="e.g. 123456" />
      <button id="checkBtn">Check</button>
    </div>

    <div id="result" aria-live="polite"></div>

    <script>
      const supabaseUrl = 'https://bpoaeuocoydvyvpyyyyl.supabase.co';
      // truncated/placeholder key left as in original file
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJwb2FldW9jb3lkdnl2cHl5eXlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NDIxNjUsImV4cCI6MjA3OTUxODE2NX0.hpcgWt7v-48PTDvchZFfShRZRYAtCCC3aS6TRBey5Ew';

      let supabaseClient;
      const resultEl = document.getElementById('result');

      document.addEventListener('DOMContentLoaded', () => {
        resultEl.textContent = "Initializing Supabase...";

        try {
          // Ensure the CDN script created a global. Use window.supabase to avoid local shadowing.
          if (!window.supabase || typeof window.supabase.createClient !== 'function') {
            throw new Error('Supabase library not found. Check CDN script tag or network.');
          }

          supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
          resultEl.textContent = "Supabase initialized. Ready.";
        } catch (e) {
          resultEl.textContent = "Supabase init failed: " + e;
        }

        // wire up the button
        document.getElementById('checkBtn').addEventListener('click', checkPostal);
      });

      async function fetchOneMapAddress(postalInput) {
        const url = `https://www.onemap.gov.sg/api/common/elastic/search?searchVal=${encodeURIComponent(
          postalInput
        )}&returnGeom=Y&getAddrDetails=Y`;

        try {
          const resp = await fetch(url);
          if (!resp.ok) {
            throw new Error(`OneMap API returned ${resp.status}`);
          }
          const payload = await resp.json();
          if (payload && Array.isArray(payload.results) && payload.results.length > 0) {
            // Return the ADDRESS field from the first result (if present)
            return payload.results[0].ADDRESS || null;
          }
          return null;
        } catch (err) {
          // propagate error to caller
          throw new Error('OneMap fetch failed: ' + err.message);
        }
      }

      async function checkPostal() {
        // clear previous result
        resultEl.innerHTML = '';
        const postalCode = document.getElementById('postalInput').value.trim();
        if (!postalCode) {
          const p = document.createElement('p');
          p.className = 'status';
          p.textContent = 'Please enter a postal code.';
          resultEl.appendChild(p);
          return;
        }

        // show a brief status
        const statusP = document.createElement('p');
        statusP.className = 'status';
        statusP.textContent = 'Checking...';
        resultEl.appendChild(statusP);

        // 1) Query OneMap for address (show address result)
        let address = null;
        try {
          statusP.textContent = 'Querying OneMap for address...';
          address = await fetchOneMapAddress(postalCode);
        } catch (err) {
          // show OneMap error but continue to Supabase check
          const errP = document.createElement('p');
          errP.className = 'status';
          errP.textContent = err.message;
          resultEl.appendChild(errP);
        }

        const addrP = document.createElement('p');
        addrP.className = 'status';
        addrP.textContent = 'Address: ' + (address || 'No address found for that postal code.');
        resultEl.appendChild(addrP);

        // 2) Query Supabase for service boundary
        if (!supabaseClient) {
          const supP = document.createElement('p');
          supP.className = 'status';
          supP.textContent = 'Supabase not initialized!';
          resultEl.appendChild(supP);
          return;
        }

        try {
          statusP.textContent = `Querying Supabase for postal code: ${postalCode}...`;

          // Use maybeSingle() so a 0-row result returns data = null instead of an error.
          const { data, error } = await supabaseClient
            .from('postal_codes')
            .select('postal_code')
            .eq('postal_code', postalCode)
            .maybeSingle();

          if (error) {
            const errP = document.createElement('p');
            errP.className = 'status';
            errP.textContent = 'Error: ' + error.message;
            resultEl.appendChild(errP);
            return;
          }

          const boundaryP = document.createElement('p');
          boundaryP.className = 'status boundary'; // apply spacing, large font and bold
          if (data) {
            boundaryP.textContent = 'In service boundary';
          } else {
            boundaryP.textContent = 'Out of boundary';
            boundaryP.classList.add('out'); // makes it red
          }
          resultEl.appendChild(boundaryP);
        } catch (err) {
          const exP = document.createElement('p');
          exP.className = 'status';
          exP.textContent = 'Exception: ' + err;
          resultEl.appendChild(exP);
        }
      }
    </script>
  </body>
</html>
